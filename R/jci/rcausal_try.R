# source('./jci/load_simdata.R')
# source('./jci/graphviz_dot.R')
# source('./jci/process_trueGraph.R')
# sourceDir('./jci',trace=FALSE)
runGFCI <- function(method = 'gfci', # either gfci or fges
                    data_type = 'sim', # either sachs or sim or obs
                    addPrior = TRUE, # use background knowledge
                    prior = c(), # specify background knowledge
                    n = 11, # number of variables
                    numInts = 7, # number of interventions
                    N = 500,
                    howmany = 100, # howmany simulated experiments 
                    showGraphs = TRUE,
                    bootstrap=0 # how many bootstrap iterations
){
  true_models <- c() # list that will contain all causal matrices for all simulated data.
  learnt_models <- c() # list that will contain all causal matrices for learnt models for simulated data.
  allHits <- c()
  allfPositives <- c()
  allTotals <- c()
  recall <- c()
  precision <- c()
  start  <- proc.time()

  for (i in 1:howmany){
      # get data
      if (data_type == 'sachs') {
          
          if (howmany>1) {
              stop("Doesn't make sense to run Sachs experiments more than once.")
          }
          
          data <- loadSachsData()
          
          if (addPrior) {
              intv <- colnames(data[(n+1):ncol(data)])
              forbiddenWithin <- intv
              class(forbiddenWithin) <- 'forbiddenWithin' # Make this tier forbidden within
              temporal <- list(forbiddenWithin,colnames(data)[1:n]) # List of temporal node tiers
              prior <- priorKnowledge(addtemporal = temporal)
          }
      } else if (data_type == 'sim') {
          sim_data <-loadSimulatedData(n=n, N=N, numInts=numInts, i=i)
          data <- sim_data$data
          
          trueGraph  <- sim_data$trueGraph
          true_models <- c(true_models, as.vector(trueGraph))
          
          
          # TODO: not correct, use intervention variables and discard the regime, then use background knowledge
          # than no intervention variable causes the others (similar to sachs)
          if (addPrior) {
              intv <- colnames(data[(n+1):ncol(data)])
              forbiddenWithin <- intv
              class(forbiddenWithin) <- 'forbiddenWithin' # Make this tier forbidden within
              temporal <- list(forbiddenWithin,colnames(data)[1:n]) # List of temporal node tiers
              prior <- priorKnowledge(addtemporal = temporal)
          }
      } else if (data_type == 'obsS') {
        
        if (howmany>1) {
          stop("Doesn't make sense to run Sachs experiments more than once.")
        }
        data <- loadObservational()
        N <- dim(data)[1]
      }
      
      # execute method
      if (method == 'fges') {
          if (bootstrap==0) {
            results <- fges(df = data, penaltydiscount = 2, maxDegree = -1, numOfThreads = 2, verbose = FALSE, priorKnowledge = prior)
            causalMatrix <- gfci2causal(n=(n+numInts),results=results,vnames=colnames(data))
          } else {
            results <- bootstrapgfci(data=data,n=(n+numInts),N=N,repeat_bootstrap = bootstrap,prior=prior,method=method)
            causalMatrix <- results$causalMatrix
          }
          if (showGraphs) {
            gfci_graph(results)
            # plot(results$graphNEL, nodeAttrs=makeNodeAttrs(results$graphNEL, fontsize=20))
          }
      } else if (method == 'gfci') {
          if (bootstrap == 0) {
            results <- gfci(df = data, priorKnowledge = prior,maxDegree = -1,penaltydiscount = 1,completeRuleSetUsed=TRUE, verbose=FALSE)
            causalMatrix <- gfci2causal(n=(n+numInts),results=results,vnames=colnames(data))
          } else {
            results <- bootstrapgfci(data=data,n=(n+numInts),N=N,repeat_bootstrap = bootstrap,prior=prior,method=method)
            causalMatrix <- results$causalMatrix
          }
          if (showGraphs) {
            gfci_graph(results)
          }
      }
      
      if (data_type == 'sim') {
          
          if (showGraphs) {
            processed_tgraph <- process_trueGraph(trueGraph)
            gfci_graph(processed_tgraph)
          }
          
          results$tPositives <- length(intersect(which(causalMatrix> 0), which(trueGraph> 0)))
          results$fPositives <-length(which(causalMatrix> 0))-results$tPositives
          results$total <- length(trueGraph[trueGraph>0])
          
          print(paste("Hits: ", results$tPositives))
          print(paste("Number of false positives:", results$fPositives ))
          
          # ratio 
          allHits[i] <- results$tPositives
          allTotals[i] <- results$total
          allfPositives[i] <- results$fPositives
          recall[i] <- sum(allHits)/sum(allTotals)
          precision[i] <- sum(allHits)/(sum(allfPositives) + sum(allHits))
          
      }
      
      learntGraph <- causalMatrix
      
      learnt_models <- c(learnt_models, as.vector(learntGraph))
  }
  if (data_type == 'sachs') {
    gfci_graphviz(results,loc= paste("./jci/results/sachsGraph", "_bootstrap", bootstrap,"_prior", addPrior, method, ".dot", sep=""))
  } else if (data_type == 'obsS') {
    gfci_graphviz(results,loc= paste("./jci/results/obsSachsGraph", "_bootstrap", bootstrap,"_prior", addPrior, method, ".dot", sep=""))
  }
  stop <- proc.time()
  print(stop - start)
  if (data_type == 'sim') {
    # plot(recall,precision)
    print(paste("Mean recall: "), mean(recall))
    print(paste("Mean precision: "), mean(precision))
    printSingleRocCurve(learnt_models, true_models, method, paste("./jci/results/rocCurve_", howmany, "_bootstrap", bootstrap,"_prior", addPrior,method, ".pdf", sep=""))
  }

  return(list(eval = list(recall=recall,precision=precision), models = list(learnt_models=learnt_models, true_models=true_models), time = (stop-start)))
}

doSimTests <- function(method='gfci') {
  clearnt <- c()
  a <- runGFCI(method=method,addPrior=TRUE,howmany=100,bootstrap=0)
  ctrue <- a$models$true_models
  clearnt <- cbind(clearnt, a$models$learnt_models)
  a <- runGFCI(method=method,addPrior=FALSE,howmany=100,bootstrap=0)
  clearnt <- cbind(clearnt, a$models$learnt_models)
  a <- runGFCI(method=method,addPrior=TRUE,howmany=100,bootstrap=10)
  clearnt <- cbind(clearnt, a$models$learnt_models)
  a <- runGFCI(method=method,addPrior=FALSE,howmany=100,bootstrap=10)
  clearnt <- cbind(clearnt, a$models$learnt_models)

  printRocCurves(clearnt, ctrue, c(paste(method,"1",sep=""), paste(method,"2",sep=""),paste(method,"3",sep=""),paste(method,"4",sep="")), paste("./jci/results/combinedSimCurves",method,".pdf",sep=""))
  
  return(list(clearnt=clearnt, ctrue=ctrue))
}

doSachsTests <- function(method='gfci') {
  clearnt <- c()
  a <- runGFCI(method=method,data_type='sachs',addPrior=TRUE,howmany=1,bootstrap=0,numInts = 7)
  clearnt <- cbind(clearnt, a$models$learnt_models)
  a <- runGFCI(method=method,data_type='sachs',addPrior=FALSE,howmany=1,bootstrap=0,numInts = 7)
  clearnt <- cbind(clearnt, a$models$learnt_models)
  # a <- runGFCI(method='gfci',data_type='sachs',addPrior=TRUE,howmany=1,bootstrap=10,numInts = 7)
  # clearnt <- cbind(clearnt, a$models$learnt_models)
  # a <- runGFCI(method='gfci',data_type='sachs',addPrior=FALSE,howmany=1,bootstrap=10,numInts = 7)
  # clearnt <- cbind(clearnt, a$models$learnt_models)
  
  # printRocCurves(clearnt, ctrue, c(paste(method,"1",sep=""), paste(method,"2",sep=""),paste(method,"3",sep=""),paste(method,"4",sep="")), paste("./jci/results/combinedSachsCurves",method,".pdf",sep=""))
  
  return(clearnt)
}

# 
# rm(list=ls())
# setwd('~/aci/R/')
# source('load.R')
# loud()
# a <- runGFCI(method='fges',addPrior=FALSE,howmany=100,bootstrap=10)
# write.csv(x=a$models$learnt_models,file='fges4.csv')
# printRocCurves(as.matrix(a$models$learnt_models),a$models$true_models, 'fges4', './jci/results/fges4.pdf')
